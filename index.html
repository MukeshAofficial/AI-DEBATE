<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Debater</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
    <style>
        /* ... (Your CSS styles from the previous example) ... */
        .debate-transcript {
            max-height: 400px;
            overflow-y: auto;
            @apply p-4 bg-gray-800 border border-gray-700 rounded-md shadow-md text-gray-200;
        }

        .speaker-turn-indicator {
            @apply absolute top-1 right-1 w-2 h-2 rounded-full bg-gray-600;
        }

        .speaker-turn-indicator.active {
            @apply bg-green-500 animate-pulse;
        }

        .speaker-box {
            @apply relative p-6 bg-gray-900 rounded-lg shadow-xl flex flex-col items-center text-center border border-gray-700;
        }

        .gradient-text {
            background: linear-gradient(45deg, #6366f1, #8b5cf6, #d946ef);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .content-container {
            @apply bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700;
            min-height: 200px;
        }
    </style>
</head>

<body class="bg-gray-900 font-sans antialiased text-gray-100">
    <div class="container mx-auto px-4 py-10">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-3 gradient-text animate__animated animate__fadeInDown">AI Debater</h1>
            <p class="text-md text-gray-500 mt-2 animate__animated animate__fadeInUp animate__delay-1s">Experience the
                future of intellectual discourse</p>
        </header>

        <!-- AI Debater -->
        <div class="speaker-box animate__animated animate__fadeInDown animate__delay-0.5s mb-8">
            <div class="speaker-turn-indicator" id="aiDebaterTurnIndicator"></div>
            <h3 class="text-xl font-semibold text-purple-400 mb-3"></h3>
            <div class="flex justify-center">
                <div id="aiThinkingIndicator" class="hidden">
                    <div
                        class="loader ease-linear border-2 border-t-2 border-gray-200 h-8 w-8 rounded-full animate-spin">
                    </div>
                    <p class="text-sm text-gray-400 mt-2">Thinking...</p>
                </div>
                <p id="aiDebaterStatus" class="text-sm text-gray-400"></p>
            </div>
        </div>

        <!-- Content Container -->
        <div class="content-container animate__animated animate__fadeIn animate__delay-1s">
            <!-- Empty container for content -->
        </div>

        <!-- Control Buttons -->
        <div class="flex space-x-4 justify-center mb-8 animate__animated animate__fadeInUp animate__delay-1.5s">
            <button id="listenButton"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline flex-1 max-w-[200px] flex items-center justify-center">
                <i class="material-icons align-middle mr-2">hearing</i> Listen
            </button>
            <button id="speakButton" disabled
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full focus:outline-none focus:shadow-outline flex-1 max-w-[200px] flex items-center justify-center">
                <i class="material-icons align-middle mr-2">record_voice_over</i> Speak
            </button>
        </div>

        <!-- Debate Transcript -->
        <section class="mb-12 animate__animated animate__fadeIn animate__delay-2s">
            <h2 class="text-2xl font-semibold text-gray-100 mb-4">Debate Transcript</h2>
            <div id="debateTranscriptLog" class="debate-transcript">
                <p class="text-gray-400 italic text-sm text-center">Transcript will appear here...</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center text-gray-600 mt-16 border-t border-gray-700 pt-4">
            <p>AI Debater 2025</p>
        </footer>
    </div>

    <script>
        const debateTranscriptLog = document.getElementById('debateTranscriptLog');
        const listenButton = document.getElementById('listenButton');
        const speakButton = document.getElementById('speakButton');
        const aiDebaterStatus = document.getElementById('aiDebaterStatus');
        const aiDebaterTurnIndicator = document.getElementById('aiDebaterTurnIndicator');
        const aiThinkingIndicator = document.getElementById('aiThinkingIndicator');

        let mediaRecorder;
        let audioChunks = [];
        let isListening = false;
        let conversationId = localStorage.getItem('conversationId') || generateConversationId(); // Unique ID for the conversation

        function generateConversationId() {
            const newId = crypto.randomUUID();
            localStorage.setItem('conversationId', newId);
            return newId;
        }

        function displayTranscriptMessage(speaker, message) {
            const messageElement = document.createElement('p');
            messageElement.classList.add('text-gray-200', 'mb-2', 'animate__animated', 'animate__fadeIn');
            messageElement.innerHTML = `<b>${speaker}:</b> ${message}`;
            debateTranscriptLog.appendChild(messageElement);
            debateTranscriptLog.scrollTop = debateTranscriptLog.scrollHeight;
        }

        function setAiDebaterStatus(message) {
            aiDebaterStatus.textContent = message;
        }

        function activateTurnIndicator(indicatorElement) {
            indicatorElement.classList.add('active');
        }

        function deactivateTurnIndicator(indicatorElement) {
            indicatorElement.classList.remove('active');
        }

        function resetUIButtons() {
            listenButton.disabled = false;
            speakButton.disabled = true;
            setAiDebaterStatus("");
            deactivateTurnIndicator(aiDebaterTurnIndicator);
            aiThinkingIndicator.classList.add('hidden');
            aiThinkingIndicator.classList.remove('flex');
        }

        async function startListening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioBase64 = await blobToBase64(audioBlob);
                    displayTranscriptMessage("You", "Recording Finished. Sending to AI...");
                    await sendAudioToBackend(audioBase64); // Send the recorded audio to backend
                    resetUIButtons(); // Reactivate listen, diable speak.
                };

                mediaRecorder.start();
                isListening = true; // Set listening status
                listenButton.textContent = "Listening... (Click again to stop)"; // Change button label
            } catch (error) {
                console.error("Error accessing microphone:", error);
                setAiDebaterStatus("Error: Could not access microphone.");
                resetUIButtons();
            }
        }

        function stopListening() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isListening = false;
                listenButton.textContent = '<i class="material-icons align-middle mr-2">hearing</i> Listen';
            }
        }

        // Toggle the listening state
        listenButton.addEventListener('click', () => {
            if (!isListening) {
                startListening();
                speakButton.disabled = true; // Diable speak during listening
            } else {
                stopListening();
                speakButton.disabled = true; // Disable speak as stopping.
                listenButton.disabled = true;
                setAiDebaterStatus("Stopping recording...");
                deactivateTurnIndicator(aiDebaterTurnIndicator);
            }
        });

        speakButton.addEventListener('click', () => {
            listenButton.disabled = true;
            speakButton.disabled = true;
            setAiDebaterStatus("Thinking...");
            activateTurnIndicator(aiDebaterTurnIndicator);
            aiThinkingIndicator.classList.remove('hidden');
            aiThinkingIndicator.classList.add('flex');
            console.log("Speaking started");
        });

        // Convert Blob to Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]); // Remove the Data URI prefix
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }


        // Send audio to backend
        async function sendAudioToBackend(audioBase64) {
            try {
                const response = await fetch('http://localhost:8000/debate-turn/', { // Backend URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        audio_data: audioBase64,
                        conversation_id: conversationId,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                displayTranscriptMessage("AI", data.ai_response_text);
                playAudioFromBase64(data.ai_response_audio_base64);

            } catch (error) {
                console.error("Error sending audio to backend:", error);
                setAiDebaterStatus("Error processing audio. Please try again.");
            } finally {
                resetUIButtons();
            }
        }

        // Function to play audio from Base64 data
        function playAudioFromBase64(base64Audio) {
            const audio = new Audio(`data:audio/mpeg;base64,${base64Audio}`);
            audio.play().catch(error => {
                console.error("Error playing audio:", error);
                setAiDebaterStatus("Error playing AI audio.");
            });
        }

        resetUIButtons();
    </script>

    <style>
        @keyframes loader-spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loader {
            border-radius: 50%;
            border-width: 0.25rem;
            border-color: theme('colors.gray.200');
            border-top-color: theme('colors.blue.500');
            animation: loader-spin 1s linear infinite;
        }
    </style>
</body>

</html>